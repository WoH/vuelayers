{"version":3,"file":"features-container.js","sources":["src/mixin/features-container.js"],"sourcesContent":["import Collection from 'ol/Collection'\nimport Feature from 'ol/Feature'\nimport Vue from 'vue'\nimport { merge as mergeObs } from 'rxjs/observable'\nimport { tap, debounceTime } from 'rxjs/operators'\nimport { getFeatureId, getObjectUid, initializeFeature, mergeFeatures } from '../ol-ext'\nimport { instanceOf } from '../util/assert'\nimport { forEach, isPlainObject } from '../util/minilo'\nimport projTransforms from './proj-transforms'\nimport rxSubs from './rx-subs'\nimport { observableFromOlEvent } from '../rx-ext'\n\nexport default {\n  mixins: [rxSubs, projTransforms],\n  computed: {\n    featureIds () {\n      if (!this.rev) return []\n\n      return this.getFeatures().map(getFeatureId)\n    },\n    featuresViewProj () {\n      if (!this.rev) return []\n\n      return this.getFeatures().map(::this.writeFeatureInViewProj)\n    },\n    featuresDataProj () {\n      if (!this.rev) return []\n\n      return this.getFeatures().map(::this.writeFeatureInDataProj)\n    },\n  },\n  methods: {\n    /**\n     * @param {Array<(Feature|Vue|Object)>} features\n     * @return {void}\n     */\n    addFeatures (features) {\n      forEach(features, ::this.addFeature)\n    },\n    /**\n     * @param {Feature|Vue|Object} feature\n     * @return {void}\n     */\n    addFeature (feature) {\n      if (feature instanceof Vue) {\n        feature = feature.$feature\n      } else if (isPlainObject(feature)) {\n        feature = this.readFeatureInDataProj(feature)\n      }\n      instanceOf(feature, Feature)\n      initializeFeature(feature)\n\n      const foundFeature = this.getFeatureById(getFeatureId(feature))\n      if (foundFeature == null) {\n        this._featuresCollection.push(feature)\n      } else {\n        mergeFeatures(foundFeature, feature)\n      }\n    },\n    /**\n     * @param {Array<(Feature|Vue|Object)>} features\n     * @return {void}\n     */\n    removeFeatures (features) {\n      forEach(features, ::this.removeFeature)\n    },\n    /**\n     * @param {Feature|Vue|Object} feature\n     * @return {void}\n     */\n    removeFeature (feature) {\n      feature = this.getFeatureById(getFeatureId(feature))\n      if (!feature) return\n\n      initializeFeature(feature)\n      this._featuresCollection.remove(feature)\n    },\n    /**\n     * @return {void}\n     */\n    clearFeatures () {\n      this._featuresCollection.clear()\n    },\n    /**\n     * @param {string|number} featureId\n     * @return {Feature|undefined}\n     */\n    getFeatureById (featureId) {\n      // todo add hash {featureId => featureIdx, ....}\n      return this._featuresCollection.getArray().find(feature => {\n        return getFeatureId(feature) === featureId\n      })\n    },\n    /**\n     * @return {Feature[]}\n     */\n    getFeatures () {\n      return this._featuresCollection.getArray()\n    },\n    /**\n     * @return {Collection<Feature>>}\n     */\n    getFeaturesCollection () {\n      return this._featuresCollection\n    },\n    /**\n     * @returns {Object}\n     * @protected\n     */\n    getServices () {\n      const vm = this\n\n      return {\n        get featuresContainer () { return vm },\n      }\n    },\n  },\n  created () {\n    /**\n     * @type {Collection<Feature>>}\n     * @private\n     */\n    this._featuresCollection = new Collection()\n    this._featureSubs = {}\n\n    const add = observableFromOlEvent(this._featuresCollection, 'add')\n      .pipe(\n        tap(({ element }) => {\n          const elementUid = getObjectUid(element)\n          const propChanges = observableFromOlEvent(element, 'propertychange')\n          const otherChanges = observableFromOlEvent(element, 'change')\n          const featureChanges = mergeObs(propChanges, otherChanges).pipe(\n            debounceTime(1000 / 60)\n          )\n\n          this._featureSubs[elementUid] = this.subscribeTo(featureChanges, () => {\n            ++this.rev\n          })\n        })\n      )\n    const remove = observableFromOlEvent(this._featuresCollection, 'remove')\n      .pipe(\n        tap(({ element }) => {\n          const elementUid = getObjectUid(element)\n          if (!this._featureSubs[elementUid]) {\n            return\n          }\n\n          this.unsubscribe(this._featureSubs[elementUid])\n          delete this._featureSubs[elementUid]\n        })\n      )\n    const events = mergeObs(add, remove)\n\n    this.subscribeTo(events, ({ type, element }) => {\n      ++this.rev\n\n      this.$emit(type + ':feature', element)\n    })\n  },\n}\n"],"names":["mixins","rxSubs","projTransforms","computed","featureIds","rev","getFeatures","map","getFeatureId","featuresViewProj","writeFeatureInViewProj","featuresDataProj","writeFeatureInDataProj","methods","addFeatures","features","forEach","addFeature","feature","Vue","$feature","isPlainObject","readFeatureInDataProj","instanceOf","Feature","initializeFeature","foundFeature","getFeatureById","_featuresCollection","push","mergeFeatures","removeFeatures","removeFeature","remove","clearFeatures","clear","featureId","getArray","find","getFeaturesCollection","getServices","vm","featuresContainer","created","Collection","_featureSubs","add","observableFromOlEvent","pipe","tap","element","elementUid","getObjectUid","propChanges","otherChanges","featureChanges","mergeObs","debounceTime","subscribeTo","unsubscribe","events","type","$emit"],"mappings":"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"}