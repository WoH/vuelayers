{"version":3,"file":"geometry.js","sources":["src/mixin/geometry.js"],"sourcesContent":["import { distinctUntilChanged, map as mapObs, throttleTime } from 'rxjs/operators'\nimport { boundingExtent, findPointOnSurface, transforms } from '../ol-ext'\nimport { observableFromOlEvent } from '../rx-ext'\nimport { hasGeometry } from '../util/assert'\nimport { isEqual } from '../util/minilo'\nimport mergeDescriptors from '../util/multi-merge-descriptors'\nimport cmp from './ol-virt-cmp'\nimport projTransforms from './proj-transforms'\nimport useMapCmp from './use-map-cmp'\n\nexport default {\n  mixins: [cmp, useMapCmp, projTransforms],\n  props: {\n    /**\n     * Coordinates in the map view projection.\n     * @type {number[]}\n     */\n    coordinates: {\n      type: Array,\n      required: true,\n      validator: val => val.length,\n    },\n  },\n  computed: {\n    /**\n     * @type {string}\n     * @abstract\n     * @readonly\n     */\n    type () {\n      throw new Error('Not implemented computed property')\n    },\n    /**\n     * @type {number[]|undefined}\n     */\n    extent () {\n      if (this.extentViewProj && this.resolvedDataProjection) {\n        return this.extentToDataProj(this.extentViewProj)\n      }\n    },\n    /**\n     * @type {number[]|undefined}\n     */\n    extentViewProj () {\n      if (this.rev && this.$geometry) {\n        return this.$geometry.getExtent()\n      }\n    },\n    /**\n     * @type {number[]|undefined}\n     */\n    point () {\n      if (this.pointViewProj && this.resolvedDataProjection) {\n        return this.pointToDataProj(this.pointViewProj)\n      }\n    },\n    /**\n     * @type {number[]}\n     */\n    pointViewProj () {\n      if (this.rev && this.$geometry) {\n        return findPointOnSurface(this.$geometry)\n      }\n    },\n    /**\n     * @type {number[]|undefined}\n     */\n    coordinatesViewProj () {\n      if (this.rev && this.$geometry) {\n        return this.$geometry.getCoordinates()\n      }\n    },\n  },\n  methods: {\n    /**\n     * @return {module:ol/geom/Geometry~Geometry|Promise<module:ol/geom/Geometry~Geometry>}\n     * @protected\n     */\n    createOlObject () {\n      return this.createGeometry()\n    },\n    /**\n     * @return {module:ol/geom/Geometry~Geometry|Promise<module:ol/geom/Geometry~Geometry>}\n     * @protected\n     * @abstract\n     */\n    createGeometry () {\n      throw new Error('Not implemented method')\n    },\n    /**\n     * @return {number[]}\n     */\n    getCoordinates () {\n      hasGeometry(this)\n\n      return this.toDataProj(this.$geometry.getCoordinates())\n    },\n    /**\n     * @param {number[]} coordinates\n     */\n    setCoordinates (coordinates) {\n      hasGeometry(this)\n\n      this.$geometry.setCoordinates(this.toViewProj(coordinates))\n    },\n    /**\n     * @return {Promise}\n     * @throws {AssertionError}\n     * @protected\n     */\n    init () {\n      this.setupTransformFunctions()\n\n      return this::cmp.methods.init()\n    },\n    /**\n     * @protected\n     */\n    setupTransformFunctions () {\n      // define helper methods based on geometry type\n      const { transform } = transforms[this.type]\n      /**\n       * @method\n       * @param {number[]} coordinates\n       * @return {number[]}\n       * @protected\n       */\n      this.toDataProj = coordinates => transform(coordinates, this.viewProjection, this.resolvedDataProjection)\n      /**\n       * @method\n       * @param {number[]} coordinates\n       * @return {number[]}\n       * @protected\n       */\n      this.toViewProj = coordinates => transform(coordinates, this.resolvedDataProjection, this.viewProjection)\n    },\n    /**\n     * @return {void|Promise}\n     * @protected\n     */\n    deinit () {\n      return this::cmp.methods.deinit()\n    },\n    /**\n     * @return {Promise}\n     */\n    refresh () {\n      return this::cmp.methods.refresh()\n    },\n    /**\n     * @return {Object}\n     * @protected\n     */\n    getServices () {\n      const vm = this\n\n      return mergeDescriptors(this::cmp.methods.getServices(), {\n        get geometry () { return vm.$geometry },\n      })\n    },\n    /**\n     * @return {void}\n     * @protected\n     */\n    mount () {\n      this.$geometryContainer && this.$geometryContainer.setGeometry(this)\n      this.subscribeAll()\n    },\n    /**\n     * @return {void}\n     * @protected\n     */\n    unmount () {\n      this.unsubscribeAll()\n      this.$geometryContainer && this.$geometryContainer.setGeometry(undefined)\n    },\n    /**\n     * @return {void}\n     * @protected\n     */\n    subscribeAll () {\n      this::subscribeToGeomChanges()\n    },\n  },\n  watch: {\n    coordinates (value) {\n      if (!this.$geometry || !this.$view) return\n\n      // compares in data projection\n      let isEq = isEqualGeom({\n        coordinates: value,\n        extent: boundingExtent(value),\n      }, {\n        coordinates: this.getCoordinates(),\n        extent: this.extent,\n      })\n\n      if (isEq) return\n\n      this.setCoordinates(value)\n    },\n    resolvedDataProjection () {\n      if (!this.$geometry) return\n\n      this.setupTransformFunctions()\n      this.setCoordinates(this.coordinates)\n    },\n  },\n  stubVNode: {\n    empty () {\n      return this.$options.name\n    },\n  },\n  created () {\n    this::defineServices()\n  },\n}\n\nfunction defineServices () {\n  Object.defineProperties(this, {\n    /**\n     * @type {module:ol/geom/Geometry~Geometry|undefined}\n     */\n    $geometry: {\n      enumerable: true,\n      get: () => this.$olObject,\n    },\n    /**\n     * @type {module:ol/PluggableMap~PluggableMap|undefined}\n     */\n    $map: {\n      enumerable: true,\n      get: () => this.$services && this.$services.map,\n    },\n    /**\n     * @type {module:ol/View~View|undefined}\n     */\n    $view: {\n      enumerable: true,\n      get: () => this.$services && this.$services.view,\n    },\n    /**\n     * @type {Object|undefined}\n     */\n    $geometryContainer: {\n      enumerable: true,\n      get: () => this.$services && this.$services.geometryContainer,\n    },\n  })\n}\n\n/**\n * @return {void}\n * @private\n */\nfunction subscribeToGeomChanges () {\n  hasGeometry(this)\n\n  const ft = 100\n  const changes = observableFromOlEvent(\n    this.$geometry,\n    'change',\n    () => ({\n      coordinates: this.getCoordinates(),\n      extent: this.extent,\n    }),\n  ).pipe(\n    throttleTime(ft),\n    distinctUntilChanged(isEqualGeom),\n    mapObs(({ coordinates }) => ({\n      prop: 'coordinates',\n      value: coordinates,\n    })),\n  )\n\n  this.subscribeTo(changes, ({ prop, value }) => {\n    ++this.rev\n    this.$emit(`update:${prop}`, value)\n  })\n}\n\n/**\n * @param {{coordinates: number[], extent: number[]}} a\n * @param {{coordinates: number[], extent: number[]}} b\n * @returns {boolean}\n */\nfunction isEqualGeom (a, b) {\n  return isEqual(a.extent, b.extent)\n    ? isEqual(a.coordinates, b.coordinates)\n    : false\n}\n"],"names":["mixins","cmp","useMapCmp","projTransforms","props","coordinates","type","Array","required","validator","val","length","computed","Error","extent","extentViewProj","resolvedDataProjection","extentToDataProj","rev","$geometry","getExtent","point","pointViewProj","pointToDataProj","findPointOnSurface","coordinatesViewProj","getCoordinates","methods","createOlObject","createGeometry","hasGeometry","toDataProj","setCoordinates","toViewProj","init","setupTransformFunctions","transform","transforms","viewProjection","deinit","refresh","getServices","vm","mergeDescriptors","geometry","mount","$geometryContainer","setGeometry","subscribeAll","unmount","unsubscribeAll","undefined","subscribeToGeomChanges","watch","value","$view","isEq","isEqualGeom","boundingExtent","stubVNode","empty","$options","name","created","defineServices","Object","defineProperties","enumerable","get","$olObject","$map","$services","map","view","geometryContainer","ft","changes","observableFromOlEvent","pipe","throttleTime","distinctUntilChanged","mapObs","prop","subscribeTo","$emit","a","b","isEqual"],"mappings":"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"}