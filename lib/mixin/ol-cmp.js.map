{"version":3,"file":"ol-cmp.js","sources":["src/mixin/ol-cmp.js"],"sourcesContent":["import debounce from 'debounce-promise'\nimport { interval as intervalObs } from 'rxjs/observable'\nimport { first as firstObs, skipUntil, skipWhile } from 'rxjs/operators'\nimport { log } from '../util/log'\nimport { identity, isFunction } from '../util/minilo'\nimport identMap from './ident-map'\nimport rxSubs from './rx-subs'\nimport services from './services'\n\nconst VM_PROP = 'vm'\nconst INSTANCE_PROMISE_POOL = 'instance_promise'\n\n/**\n * Basic ol component mixin.\n * todo try to subscribe to generic change event here and update rev according to internal ol counter\n */\nexport default {\n  VM_PROP,\n  INSTANCE_PROMISE_POOL,\n  mixins: [identMap, rxSubs, services],\n  data () {\n    return {\n      rev: 0,\n    }\n  },\n  computed: {\n    name () {\n      return [this.$options.name, this.id].filter(identity).join(' ')\n    },\n  },\n  methods: {\n    /**\n     * @return {Promise<void>}\n     * @protected\n     */\n    beforeInit () {},\n    /**\n     * @return {Promise<void>} Resolves when initialization completes\n     * @protected\n     */\n    async init () {\n      let createPromise\n\n      const ident = this.makeSelfIdent()\n      if (ident && this.$identityMap.has(ident, INSTANCE_PROMISE_POOL)) {\n        createPromise = this.$identityMap.get(ident, INSTANCE_PROMISE_POOL)\n      } else {\n        createPromise = this.createOlObject()\n\n        if (ident) {\n          this.$identityMap.set(ident, createPromise, INSTANCE_PROMISE_POOL)\n        }\n      }\n\n      this._olObject = await createPromise\n      this._olObject[VM_PROP] || (this._olObject[VM_PROP] = [])\n\n      if (!this._olObject[VM_PROP].includes(this)) { // for loaded from IdentityMap\n        this._olObject[VM_PROP].push(this)\n      }\n\n      ++this.rev\n    },\n    /**\n     * @return {module:ol/Object~BaseObject|Promise<module:ol/Object~BaseObject>}\n     * @protected\n     * @abstract\n     */\n    createOlObject () {\n      throw new Error('Not implemented method')\n    },\n    /**\n     * @return {void|Promise<void>}\n     * @protected\n     */\n    deinit () {\n      const ident = this.makeSelfIdent()\n      if (ident) {\n        this.$identityMap.unset(ident, INSTANCE_PROMISE_POOL)\n      }\n      if (this._olObject) {\n        this._olObject[VM_PROP] = this._olObject[VM_PROP].filter(vm => vm !== this)\n        this._olObject = undefined\n      }\n    },\n    /**\n     * Redefine for easy call in child components\n     * @returns {Object}\n     * @protected\n     */\n    getServices () {\n      return this::services.methods.getServices()\n    },\n    /**\n     * @return {void|Promise<void>}\n     * @protected\n     */\n    mount () {\n      this.subscribeAll()\n    },\n    /**\n     * @return {void|Promise<void>}\n     * @protected\n     */\n    unmount () {\n      this.unsubscribeAll()\n    },\n    /**\n     * Refresh internal ol objects\n     * @return {Promise<void>}\n     */\n    refresh () {\n      if (this.$olObject == null) return Promise.resolve()\n\n      return new Promise(resolve => {\n        if (this.$olObject && isFunction(this.$olObject.changed)) {\n          this.$olObject.once('change', () => resolve())\n          this.$olObject.changed()\n        } else {\n          resolve()\n        }\n      })\n    },\n    /**\n     * Internal usage only in components that doesn't support refreshing.\n     * @return {Promise<void>}\n     * @protected\n     */\n    async remount () {\n      if (this.$olObject == null) return\n\n      await this.unmount()\n      await this.mount()\n    },\n    /**\n     * Only for internal purpose to support watching for properties\n     * for which OpenLayers doesn't provide setters.\n     * @return {Promise}\n     * @protected\n     */\n    async recreate () {\n      if (this.$olObject == null) return\n\n      await this.unmount()\n      await this.deinit()\n      await this.init()\n      await this.mount()\n    },\n    subscribeAll () {},\n  },\n  created () {\n    /**\n     * @type {module:ol/Object~BaseObject}\n     * @private\n     */\n    this._olObject = undefined\n    Object.defineProperties(this, {\n      $olObject: {\n        enumerable: true,\n        get: () => this._olObject,\n      },\n    })\n\n    this::defineLifeCyclePromises()\n    this::defineDebouncedHelpers()\n  },\n  async mounted () {\n    await this.$createPromise\n\n    this._mounted = true\n  },\n  async beforeDestroy () {\n    await this.$mountPromise\n\n    this._mounted = false\n  },\n  async destroyed () {\n    await this.$unmountPromise\n\n    this._destroyed = true\n  },\n}\n\nfunction defineLifeCyclePromises () {\n  const makeEventEmitter = event => () => {\n    this.$emit(event, this)\n\n    if (process.env.VUELAYERS_DEBUG) {\n      log(event, this.name)\n    }\n\n    return this\n  }\n  // create\n  this._createPromise = Promise.resolve(this.beforeInit())\n    .then(() => this.init())\n    .then(makeEventEmitter('created'))\n\n  // mount\n  const mountObs = intervalObs(1000 / 60)\n    .pipe(\n      skipWhile(() => !this._mounted),\n      firstObs(),\n    )\n  this._mountPromise = mountObs.toPromise(Promise)\n    .then(() => this.mount())\n    .then(makeEventEmitter('mounted'))\n\n  // unmount\n  const unmountObs = intervalObs(1000 / 60)\n    .pipe(\n      skipUntil(mountObs),\n      skipWhile(() => this._mounted),\n      firstObs(),\n    )\n  this._unmountPromise = unmountObs.toPromise(Promise)\n    .then(() => this.unmount())\n    .then(makeEventEmitter('unmounted'))\n\n  // destroy\n  const destroyObs = intervalObs(1000 / 60)\n    .pipe(\n      skipWhile(() => !this._destroyed),\n      firstObs(),\n    )\n  this._destroyPromise = destroyObs.toPromise(Promise)\n    .then(() => this.deinit())\n    .then(makeEventEmitter('destroyed'))\n\n  Object.defineProperties(this, {\n    $createPromise: {\n      enumerable: true,\n      get: () => this._createPromise,\n    },\n    $mountPromise: {\n      enumerable: true,\n      get: () => this._mountPromise,\n    },\n    $unmountPromise: {\n      enumerable: true,\n      get: () => this._unmountPromise,\n    },\n    $destroyPromise: {\n      enumerable: true,\n      get: () => this._destroyPromise,\n    },\n  })\n}\n\nfunction defineDebouncedHelpers () {\n  const t = 1000 / 10\n  // bind debounced functions at runtime\n  // for each instance to avoid interfering between\n  // different instances\n  this.scheduleRefresh = debounce(function () {\n    return this.refresh()\n  }, t)\n  this.scheduleRemount = debounce(function () {\n    return this.remount()\n  }, t)\n  this.scheduleRecreate = debounce(function () {\n    return this.recreate()\n  }, t)\n}\n"],"names":["VM_PROP","INSTANCE_PROMISE_POOL","mixins","identMap","rxSubs","services","data","rev","computed","name","$options","id","filter","identity","join","methods","beforeInit","init","ident","makeSelfIdent","$identityMap","has","createPromise","get","createOlObject","set","_olObject","includes","push","Error","deinit","unset","vm","undefined","getServices","mount","subscribeAll","unmount","unsubscribeAll","refresh","$olObject","Promise","resolve","isFunction","changed","once","remount","recreate","created","Object","defineProperties","enumerable","defineLifeCyclePromises","defineDebouncedHelpers","mounted","$createPromise","_mounted","beforeDestroy","$mountPromise","destroyed","$unmountPromise","_destroyed","makeEventEmitter","event","$emit","process","env","VUELAYERS_DEBUG","log","_createPromise","then","mountObs","intervalObs","pipe","skipWhile","firstObs","_mountPromise","toPromise","unmountObs","skipUntil","_unmountPromise","destroyObs","_destroyPromise","$destroyPromise","t","scheduleRefresh","debounce","scheduleRemount","scheduleRecreate"],"mappings":"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"}