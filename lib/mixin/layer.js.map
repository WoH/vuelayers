{"version":3,"file":"layer.js","sources":["src/mixin/layer.js"],"sourcesContent":["import uuid from 'uuid/v4'\nimport Vue from 'vue'\nimport { getLayerId, initializeLayer, setLayerId } from '../ol-ext'\nimport { hasLayer, hasMap } from '../util/assert'\nimport { isEqual } from '../util/minilo'\nimport mergeDescriptors from '../util/multi-merge-descriptors'\nimport { observableFromOlEvent } from '../rx-ext'\nimport { makeWatchers } from '../util/vue-helpers'\nimport cmp from './ol-virt-cmp'\nimport sourceContainer from './source-container'\nimport useMapCmp from './use-map-cmp'\n\nexport default {\n  mixins: [cmp, useMapCmp, sourceContainer],\n  props: {\n    id: {\n      type: [String, Number],\n      default: () => uuid(),\n    },\n    /**\n     * The bounding extent for layer rendering defined in the map view projection.\n     * The layer will not be rendered outside of this extent.\n     * @default undefined\n     * @type {number[]|undefined}\n     */\n    extent: {\n      type: Array,\n      validator: value => value.length === 4,\n    },\n    minResolution: Number,\n    maxResolution: Number,\n    opacity: {\n      type: Number,\n      default: 1,\n    },\n    overlay: {\n      type: Boolean,\n      default: false,\n    },\n    visible: {\n      type: Boolean,\n      default: true,\n    },\n    zIndex: Number,\n  },\n  methods: {\n    /**\n     * @return {Promise<module:ol/layer/BaseLayer~BaseLayer>}\n     * @protected\n     */\n    async createOlObject () {\n      let layer = await this.createLayer()\n\n      initializeLayer(layer, this.id)\n\n      return layer\n    },\n    /**\n     * @return {module:ol/layer/BaseLayer~BaseLayer|Promise<module:ol/layer/BaseLayer~BaseLayer>}\n     * @protected\n     * @abstract\n     */\n    createLayer () {\n      throw new Error('Not implemented method')\n    },\n    /**\n     * @return {Promise<Vue<module:ol/layer/BaseLayer~BaseLayer>>}\n     * @protected\n     */\n    init () {\n      return this::cmp.methods.init()\n    },\n    /**\n     * @return {void|Promise}\n     * @protected\n     */\n    deinit () {\n      return this::cmp.methods.deinit()\n    },\n    /**\n     * @param {number[]} pixel\n     * @return {boolean}\n     */\n    isAtPixel (pixel) {\n      hasMap(this)\n\n      return this.$map.forEachLayerAtPixel(pixel, layer => layer === this.$layer)\n    },\n    /**\n     * @returns {Object}\n     * @protected\n     */\n    getServices () {\n      const vm = this\n\n      return mergeDescriptors(\n        this::cmp.methods.getServices(),\n        this::sourceContainer.methods.getServices(),\n        {\n          get layer () { return vm.$layer },\n        },\n      )\n    },\n    /**\n     * @return {{\n     *     setSource: function(module:ol/source/Source~Source): void,\n     *     getSource: function(): module:ol/source/Source~Source\n     *   }|undefined}\n     * @protected\n     */\n    getSourceTarget () {\n      return this.$layer\n    },\n    /**\n     * @return {Promise}\n     * @protected\n     */\n    mount () {\n      if (this.overlay && this.$map) {\n        this.setMap(this.$map)\n      } else if (this.$layersContainer) {\n        this.$layersContainer.addLayer(this)\n      }\n\n      return this::cmp.methods.mount()\n    },\n    /**\n     * @return {Promise}\n     * @protected\n     */\n    unmount () {\n      if (this.overlay) {\n        this.setMap(undefined)\n      } else if (this.$layersContainer) {\n        this.$layersContainer.removeLayer(this)\n      }\n\n      return this::cmp.methods.unmount()\n    },\n    /**\n     * Updates layer state\n     * @return {Promise}\n     */\n    refresh () {\n      return this::cmp.methods.refresh()\n    },\n    /**\n     * Internal usage only in components that doesn't support refreshing.\n     * @return {Promise}\n     * @protected\n     */\n    remount () {\n      return this::cmp.methods.remount()\n    },\n    /**\n     * Internal usage only in components that doesn't support refreshing.\n     * @return {Promise}\n     * @protected\n     */\n    recreate () {\n      return this::cmp.methods.remount()\n    },\n    /**\n     * @protected\n     */\n    subscribeAll () {\n      this::cmp.methods.subscribeAll()\n      this::subscribeToLayerEvents()\n    },\n    /**\n     * @param {module:ol/Map~Map|Vue|undefined} map\n     */\n    setMap (map) {\n      hasLayer(this)\n\n      map = map instanceof Vue ? map.$map : map\n\n      this.$layer.setMap(map)\n    },\n  },\n  watch: {\n    id (value) {\n      if (!this.$layer || value === getLayerId(this.$layer)) {\n        return\n      }\n\n      setLayerId(this.$layer, value)\n    },\n    maxResolution (value) {\n      if (!this.$layer || value === this.$layer.getMaxResolution()) {\n        return\n      }\n\n      this.$layer.setMaxResolution(value)\n    },\n    minResolution (value) {\n      if (!this.$layer || value === this.$layer.getMinResolution()) {\n        return\n      }\n\n      this.$layer.setMinResolution(value)\n    },\n    opacity (value) {\n      if (!this.$layer || value === this.$layer.getOpacity()) {\n        return\n      }\n\n      this.$layer.setOpacity(value)\n    },\n    visible (value) {\n      if (!this.$layer || value === this.$layer.getVisible()) {\n        return\n      }\n\n      this.$layer.setVisible(value)\n    },\n    zIndex (value) {\n      if (!this.$layer || value === this.$layer.getZIndex()) {\n        return\n      }\n\n      this.$layer.setZIndex(value)\n    },\n    extent (value) {\n      if (!this.$layer || isEqual(value, this.$layer.getExtent())) {\n        return\n      }\n\n      this.$layer.setExtent(value)\n    },\n    ...makeWatchers([\n      'overlay',\n    ], () => function (value, prevValue) {\n      if (isEqual(value, prevValue)) return\n\n      this.scheduleRecreate()\n    }),\n  },\n  stubVNode: {\n    attrs () {\n      return {\n        id: [this.$options.name, this.id].join('-'),\n        class: this.$options.name,\n      }\n    },\n  },\n  created () {\n    this::defineServices()\n  },\n}\n\nfunction defineServices () {\n  Object.defineProperties(this, {\n    $layer: {\n      enumerable: true,\n      get: () => this.$olObject,\n    },\n    $map: {\n      enumerable: true,\n      get: () => this.$services && this.$services.map,\n    },\n    $view: {\n      enumerable: true,\n      get: () => this.$services && this.$services.view,\n    },\n    $layersContainer: {\n      enumerable: true,\n      get: () => this.$services && this.$services.layersContainer,\n    },\n  })\n}\n\nfunction subscribeToLayerEvents () {\n  hasLayer(this)\n\n  const events = observableFromOlEvent(this.$layer, [\n    'postcompose',\n    'precompose',\n    'render',\n  ])\n\n  this.subscribeTo(events, evt => this.$emit(evt.type, evt))\n}\n"],"names":["mixins","cmp","useMapCmp","sourceContainer","props","id","type","String","Number","default","uuid","extent","Array","validator","value","length","minResolution","maxResolution","opacity","overlay","Boolean","visible","zIndex","methods","createOlObject","createLayer","layer","initializeLayer","Error","init","deinit","isAtPixel","pixel","hasMap","$map","forEachLayerAtPixel","$layer","getServices","vm","mergeDescriptors","getSourceTarget","mount","setMap","$layersContainer","addLayer","unmount","undefined","removeLayer","refresh","remount","recreate","subscribeAll","subscribeToLayerEvents","map","hasLayer","Vue","watch","getLayerId","setLayerId","getMaxResolution","setMaxResolution","getMinResolution","setMinResolution","getOpacity","setOpacity","getVisible","setVisible","getZIndex","setZIndex","isEqual","getExtent","setExtent","makeWatchers","prevValue","scheduleRecreate","stubVNode","attrs","$options","name","join","class","created","defineServices","Object","defineProperties","enumerable","get","$olObject","$services","$view","view","layersContainer","events","observableFromOlEvent","subscribeTo","evt","$emit"],"mappings":"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"}