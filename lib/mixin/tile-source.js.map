{"version":3,"file":"tile-source.js","sources":["src/mixin/tile-source.js"],"sourcesContent":["import { createTileUrlFunction } from 'ol-tilecache/src'\nimport { observableFromOlEvent } from '../rx-ext'\nimport {\n  CACHE_SIZE,\n  EPSG_3857,\n  MAX_ZOOM,\n  MIN_ZOOM,\n  PIXEL_RATIO,\n  REPROJ_ERR_THRESHOLD,\n  TILE_SIZE,\n} from '../ol-ext/consts'\nimport { createExtentFromProjection } from '../ol-ext/extent'\nimport { createXyzGrid } from '../ol-ext/tile-grid'\nimport { hasSource } from '../util/assert'\nimport { isEqual, isString, pick, replaceTokens } from '../util/minilo'\nimport { makeWatchers } from '../util/vue-helpers'\nimport source from './source'\nimport withUrl from './with-url'\n\nexport default {\n  mixins: [source, withUrl],\n  props: {\n    cacheSize: {\n      type: Number,\n      default: CACHE_SIZE,\n    },\n    crossOrigin: String,\n    maxZoom: {\n      type: Number,\n      default: MAX_ZOOM,\n    },\n    minZoom: {\n      type: Number,\n      default: MIN_ZOOM,\n    },\n    opaque: Boolean,\n    projection: {\n      type: String,\n      default: EPSG_3857,\n    },\n    reprojectionErrorThreshold: {\n      type: Number,\n      default: REPROJ_ERR_THRESHOLD,\n    },\n    tilePixelRatio: {\n      type: Number,\n      default: PIXEL_RATIO,\n    },\n    tileSize: {\n      type: Array,\n      default: () => [TILE_SIZE, TILE_SIZE],\n      validator: value => value.length === 2,\n    },\n    /**\n     * @type {module:ol/Tile~LoadFunction}\n     */\n    tileLoadFunction: Function,\n    tileKey: String,\n    /**\n     * URL template or custom tile URL function.\n     * @type {string|module:ol/Tile~UrlFunction}\n     */\n    url: {\n      type: [String, Function],\n      required: true,\n    },\n    /**\n     * Duration of the opacity transition for rendering. To disable the opacity transition, pass `0`.\n     * @type {number}\n     */\n    transition: Number,\n  },\n  computed: {\n    /**\n     * @type {string|undefined}\n     */\n    urlTmpl () {\n      if (!isString(this.url)) {\n        return\n      }\n\n      return replaceTokens(this.url, pick(this, this.urlTokens))\n    },\n    /**\n     * @returns {function}\n     */\n    urlFunc () {\n      if (!this.url) {\n        return\n      }\n\n      let url\n      if (this.urlTmpl != null) {\n        const extent = createExtentFromProjection(this.projection)\n        url = createTileUrlFunction(this.urlTmpl, this._tileGrid, extent)\n      } else {\n        url = this.url\n      }\n\n      return url\n    },\n  },\n  methods: {\n    /**\n     * @return {Promise}\n     * @protected\n     */\n    init () {\n      /**\n       * @type {module:ol/Tile~UrlFunction}\n       * @protected\n       */\n      this._tileGrid = createXyzGrid({\n        extent: createExtentFromProjection(this.projection),\n        maxZoom: this.maxZoom,\n        minZoom: this.minZoom,\n        tileSize: this.tileSize,\n      })\n\n      return this::source.methods.init()\n    },\n    /**\n     * @return {void|Promise<void>}\n     * @protected\n     */\n    deinit () {\n      return this::source.methods.deinit()\n    },\n    /**\n     * @return {void}\n     * @protected\n     */\n    mount () {\n      this::source.methods.mount()\n    },\n    /**\n     * @return {void}\n     * @protected\n     */\n    unmount () {\n      this::source.methods.unmount()\n    },\n    subscribeAll () {\n      this::source.methods.subscribeAll()\n      this::subscribeToSourceEvents()\n    },\n  },\n  watch: {\n    opaque (value) {\n      if (!this.$source || value === this.$source.getOpaque()) {\n        return\n      }\n\n      this.scheduleRecreate()\n    },\n    tilePixelRatio (value) {\n      if (!this.$source || value === this.$source.getOpaque()) {\n        return\n      }\n\n      this.scheduleRecreate()\n    },\n    tileKey (value) {\n      if (!this.$source || value === this.$source.getKey()) {\n        return\n      }\n\n      this.$source.setKey(value)\n    },\n    tileLoadFunction (value, prevValue) {\n      if (!this.$source || isEqual(value, prevValue)) return\n\n      this.$source.setTileLoadFunction(value)\n    },\n    url () {\n      if (!this.$source) return\n\n      this.$source.setTileUrlFunction(this.createUrlFunc())\n      this.scheduleRefresh()\n    },\n    ...makeWatchers([\n      'cacheSize',\n      'crossOrigin',\n      'reprojectionErrorThreshold',\n      'transition',\n      'maxZoom',\n      'minZoom',\n      'tileSize',\n    ], () => function (value, prevValue) {\n      if (isEqual(value, prevValue)) return\n\n      this.scheduleRecreate()\n    }),\n  },\n}\n\nfunction subscribeToSourceEvents () {\n  hasSource(this)\n\n  const events = observableFromOlEvent(this.$source, [\n    'tileloadstart',\n    'tileloadend',\n    'tileloaderror',\n  ])\n\n  this.subscribeTo(events, evt => this.$emit(evt.type, evt))\n}\n"],"names":["mixins","source","withUrl","props","cacheSize","type","Number","default","CACHE_SIZE","crossOrigin","String","maxZoom","MAX_ZOOM","minZoom","MIN_ZOOM","opaque","Boolean","projection","EPSG_3857","reprojectionErrorThreshold","REPROJ_ERR_THRESHOLD","tilePixelRatio","PIXEL_RATIO","tileSize","Array","TILE_SIZE","validator","value","length","tileLoadFunction","Function","tileKey","url","required","transition","computed","urlTmpl","isString","replaceTokens","pick","urlTokens","urlFunc","extent","createExtentFromProjection","createTileUrlFunction","_tileGrid","methods","init","createXyzGrid","deinit","mount","unmount","subscribeAll","subscribeToSourceEvents","watch","$source","getOpaque","scheduleRecreate","getKey","setKey","prevValue","isEqual","setTileLoadFunction","setTileUrlFunction","createUrlFunc","scheduleRefresh","makeWatchers","hasSource","events","observableFromOlEvent","subscribeTo","evt","$emit"],"mappings":"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"}